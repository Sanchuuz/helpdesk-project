const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const Ticket = require('./models/Ticket');
require('dotenv').config();

const app = express();
// ÐÐ° Render PORT Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸, Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Ð±ÑƒÐ´ÐµÑ‚ 5000
const PORT = process.env.PORT || 5000;

// Middleware
app.use(cors());
app.use(express.json());

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº MongoDB
// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÑÐµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ Ð¸Ð· .env
const MONGO_URI =
  process.env.MONGODB_URI ||
  process.env.MONGO_URI ||
  'mongodb+srv://alejnikaleksandr71_db_user:miredmi9t@cluster0.ferjubc.mongodb.net/helpdesk?appName=Cluster0';

mongoose
  .connect(MONGO_URI)
  .then(() => console.log('âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº MongoDB'))
  .catch((err) => {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð±Ð°Ð·Ðµ:', err.message);
  });

// Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚
app.get('/', (req, res) => {
  res.send('Ð¡ÐµÑ€Ð²ÐµÑ€ Helpdesk Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!');
});

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð»Ñ Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð¯ Ð·Ð°ÑÐ²ÐºÐ¸
app.post('/api/tickets', async (req, res) => {
  try {
    const { title, description, priority } = req.body;
    const newTicket = new Ticket({ title, description, priority });
    await newTicket.save();
    res.status(201).json(newTicket);
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸:', error);
    res.status(400).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð·Ð°ÑÐ²ÐºÐ¸', error });
  }
});

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð»Ñ ÐŸÐžÐ›Ð£Ð§Ð•ÐÐ˜Ð¯ Ð²ÑÐµÑ… Ð·Ð°ÑÐ²Ð¾Ðº (Ñ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¾Ð¹)
app.get('/api/tickets', async (req, res) => {
  try {
    // Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ: ÑÐ°Ð¼Ñ‹Ðµ Ð½Ð¾Ð²Ñ‹Ðµ â€” Ð²Ð²ÐµÑ€Ñ…Ñƒ
    const tickets = await Ticket.find().sort({ createdAt: -1 });
    res.json(tickets);
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸:', error);
    res
      .status(500)
      .json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ ÑÐ¿Ð¸ÑÐºÐ°', error: error.message });
  }
});

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÑÐ²ÐºÐ¸
app.delete('/api/tickets/:id', async (req, res) => {
  try {
    await Ticket.findByIdAndDelete(req.params.id);
    res.json({ message: 'Ð—Ð°ÑÐ²ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð°' });
  } catch (error) {
    res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸' });
  }
});

app.listen(PORT, '0.0.0.0', () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
});
